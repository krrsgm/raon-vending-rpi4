<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAON - Inventory Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 28px; }
        .header-right { display: flex; gap: 15px; align-items: center; }
        .refresh-time { font-size: 12px; opacity: 0.9; }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-label { font-size: 12px; color: #999; font-weight: bold; }
        .stat-value { font-size: 32px; font-weight: bold; color: #333; margin: 10px 0; }
        .stat-icon { font-size: 32px; margin-bottom: 10px; }
        
        .machines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 20px;
        }
        
        .machine-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .machine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .machine-header h2 { font-size: 20px; color: #333; }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #27ae60;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .machine-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-box {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        
        .stat-label-small { font-size: 11px; color: #999; }
        .stat-value-small { font-size: 16px; font-weight: bold; color: #333; margin-top: 3px; }
        
        .low-stock-alert {
            background: #ffe8e8;
            border-left: 4px solid #e74c3c;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .alert-items { color: #d35400; }
        
        .items-sold {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .items-sold-title { font-weight: bold; color: #333; margin-bottom: 5px; }
        .items-sold-list { color: #667eea; }
        
        .logs-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .logs-section h3 { margin-bottom: 15px; color: #333; }
        
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            background: #fafafa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .log-line {
            padding: 5px;
            border-bottom: 1px solid #eee;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-line:hover { background: #fff; }
        
        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .chart-section h3 { margin-bottom: 15px; color: #333; }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        
        .sensor-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .sensor-stat-box {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
            text-align: center;
        }
        
        .sensor-stat-label { font-size: 11px; color: #999; font-weight: bold; }
        .sensor-stat-value { font-size: 18px; font-weight: bold; color: #333; margin-top: 5px; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .previous-day-logs {
            background: #fafafa;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alert-item {
            background: white;
            border-left: 4px solid #e74c3c;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-item.critical {
            background: #ffe8e8;
            border-left-color: #c0392b;
        }
        
        .alert-item.warning {
            background: #fff8f0;
            border-left-color: #f39c12;
        }
        
        .alert-info {
            flex: 1;
        }
        
        .alert-title {
            font-weight: bold;
            color: #c0392b;
            margin-bottom: 3px;
        }
        
        .alert-message {
            font-size: 12px;
            color: #666;
        }
        
        .alert-time {
            font-size: 11px;
            color: #999;
            margin-top: 3px;
        }
        
        .alert-actions {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }
        
        .acknowledge-btn {
            padding: 6px 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }
        
        .acknowledge-btn:hover {
            background: #229954;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š RAON Dashboard</h1>
        <div class="header-right">
            <div class="refresh-time">Last update: <span id="lastUpdate">now</span></div>
        </div>
    </div>
    
    <div class="container">
        <!-- Real-time Stats -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon">ðŸ’°</div>
                <div class="stat-label">Today's Sales</div>
                <div class="stat-value" id="todaySales">â‚±0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸ›’</div>
                <div class="stat-label">Transactions</div>
                <div class="stat-value" id="transactions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸ“¦</div>
                <div class="stat-label">Items Sold</div>
                <div class="stat-value" id="itemsSold">0</div>
            </div>
        </div>
        
        <!-- Low Stock Alerts Section -->
        <div id="alertsSection" style="margin-bottom: 30px;">
            <div class="logs-section" style="background: #fff5f5; border-left: 5px solid #e74c3c;">
                <h3 style="color: #c0392b;">ðŸš¨ Stock Alerts</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #c0392b;">
                        <div style="font-size: 12px; color: #999; font-weight: bold;">Out of Stock</div>
                        <div style="font-size: 24px; font-weight: bold; color: #c0392b;" id="criticalCount">0</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #f39c12;">
                        <div style="font-size: 12px; color: #999; font-weight: bold;">Low Stock</div>
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;" id="warningCount">0</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #667eea;">
                        <div style="font-size: 12px; color: #999; font-weight: bold;">Last Updated</div>
                        <div style="font-size: 12px; font-weight: bold; color: #667eea;" id="alertsLastUpdated">--:--</div>
                    </div>
                </div>
                <div id="alertsContainer" style="max-height: 400px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: #999;">Loading alerts...</div>
                </div>
            </div>
        </div>
        
        <!-- Machine Cards -->
        <h2 style="margin: 30px 0 15px 0;">Machines</h2>
        <div class="machines-grid" id="machinesGrid">
            <div class="machine-card">Loading...</div>
        </div>
        <!-- Sales Logs -->
        <div class="logs-section">
            <h3>ðŸ“ Sales Logs</h3>
            <div id="today-logs" class="tab-content active">
                <div style="margin-bottom: 10px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <label for="logsDatePicker" style="font-size: 12px; color: #666;">Select Date:</label>
                    <input type="date" id="logsDatePicker" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <button type="button" onclick="loadLogsFromPicker()" style="padding: 6px 10px; border: none; border-radius: 4px; background: #667eea; color: white; cursor: pointer;">Load Date</button>
                    <button type="button" onclick="loadTodayLogsNow()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; color: #333; cursor: pointer;">Today</button>
                    <span id="selectedDateLabel" style="font-size: 12px; color: #666;"></span>
                </div>
                <div class="logs-container" id="logsContainer">
                    <div class="log-line">Loading logs...</div>
                </div>
            </div>
        </div>
        <!-- Temperature & Humidity Text Logs -->
        <div class="logs-section">
            <h3>Temperature & Humidity Logs (Every 30 Minutes)</h3>
            <div style="margin-bottom: 10px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <label for="sensorTextDatePicker" style="font-size: 12px; color: #666;">Select Date:</label>
                <input type="date" id="sensorTextDatePicker" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" onclick="loadSensorTextLogsFromPicker()" style="padding: 6px 10px; border: none; border-radius: 4px; background: #667eea; color: white; cursor: pointer;">Load Date</button>
                <button type="button" onclick="loadTodaySensorTextLogs()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; color: #333; cursor: pointer;">Today</button>
                <span id="sensorTextDateLabel" style="font-size: 12px; color: #666;"></span>
            </div>
            <div class="logs-container" id="sensorTextLogsContainer">
                <div class="log-line">Loading temperature/humidity logs...</div>
            </div>
        </div>

        <!-- Sensor Readings Chart -->
        <div class="chart-section">
            <h3>Sensor Readings - Temperature & Humidity</h3>
            <div style="margin-bottom: 10px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <label for="sensorDatePicker" style="font-size: 12px; color: #666;">Select Date:</label>
                <input type="date" id="sensorDatePicker" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" onclick="loadSensorGraphFromPicker()" style="padding: 6px 10px; border: none; border-radius: 4px; background: #667eea; color: white; cursor: pointer;">Load Date</button>
                <button type="button" onclick="loadTodaySensorGraph()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; color: #333; cursor: pointer;">Today</button>
                <span id="sensorDateLabel" style="font-size: 12px; color: #666;"></span>
            </div>

                        <div id="today-chart" class="tab-content active">
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <canvas id="irSensorChart"></canvas>
                </div>
                <div class="sensor-stats-grid" id="todayStatsGrid">
                    <div class="sensor-stat-box">
                        <div class="sensor-stat-label">Avg Temp 1</div>
                        <div class="sensor-stat-value" id="avgTemp1">--Â°C</div>
                    </div>
                    <div class="sensor-stat-box">
                        <div class="sensor-stat-label">Avg Temp 2</div>
                        <div class="sensor-stat-value" id="avgTemp2">--Â°C</div>
                    </div>
                    <div class="sensor-stat-box">
                        <div class="sensor-stat-label">Avg Humidity 1</div>
                        <div class="sensor-stat-value" id="avgHumidity1">--%</div>
                    </div>
                    <div class="sensor-stat-box">
                        <div class="sensor-stat-label">Avg Humidity 2</div>
                        <div class="sensor-stat-value" id="avgHumidity2">--%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <script>
        let sensorChartInstance = null;
        let irChartInstance = null;

        function getTodayIsoDate() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderLogs(containerId, logs, emptyText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (logs && logs.length > 0) {
                container.innerHTML = logs
                    .slice(-20)
                    .reverse()
                    .map(log => `<div class="log-line">${escapeHtml(log)}</div>`)
                    .join('');
            } else {
                container.innerHTML = `<div class="log-line">${escapeHtml(emptyText)}</div>`;
            }
        }

        async function loadSalesLogsByDate(dateStr, containerId, labelId) {
            if (!dateStr) return;
            try {
                const res = await fetch('/api/sales/logs?date=' + encodeURIComponent(dateStr));
                const data = await res.json();
                renderLogs(containerId, data.logs, `No sales recorded on ${dateStr}`);
                const label = document.getElementById(labelId);
                if (label) label.textContent = 'Date: ' + dateStr;
            } catch (error) {
                console.error('Error loading sales logs:', error);
                const container = document.getElementById(containerId);
                if (container) container.innerHTML = '<div class="log-line">Error loading sales logs</div>';
            }
        }

        async function loadLogsFromPicker() {
            const picker = document.getElementById('logsDatePicker');
            const selected = picker && picker.value ? picker.value : getTodayIsoDate();
            await loadSalesLogsByDate(selected, 'logsContainer', 'selectedDateLabel');
        }

        async function loadTodayLogsNow() {
            const today = getTodayIsoDate();
            const picker = document.getElementById('logsDatePicker');
            if (picker) picker.value = today;
            await loadSalesLogsByDate(today, 'logsContainer', 'selectedDateLabel');
        }

        function toTimeLabel(timestamp, fallbackIndex) {
            if (!timestamp) return String(fallbackIndex || '');
            const parsed = new Date(timestamp);
            if (!Number.isNaN(parsed.getTime())) {
                const hh = String(parsed.getHours()).padStart(2, '0');
                const mm = String(parsed.getMinutes()).padStart(2, '0');
                return `${hh}:${mm}`;
            }
            const txt = String(timestamp);
            return txt.length >= 16 ? txt.substring(11, 16) : txt;
        }

        function parseIRValue(rawValue) {
            if (rawValue === null || rawValue === undefined) return null;
            const value = String(rawValue).trim().toLowerCase();
            if (value === '') return null;
            if (value === '1' || value === 'true' || value === 'detected' || value.includes('detect')) return 1;
            if (value === '0' || value === 'false' || value === 'not detected' || value.includes('clear')) return 0;
            const numericValue = Number(value);
            if (!Number.isNaN(numericValue)) return numericValue > 0 ? 1 : 0;
            return null;
        }

        function roundOne(value) {
            if (value === null || value === undefined || Number.isNaN(Number(value))) return null;
            return Math.round(Number(value) * 10) / 10;
        }

        function buildThirtyMinuteTextLogs(readings) {
            const buckets = new Map();
            readings.forEach((reading, index) => {
                const rawTs = reading && reading.timestamp ? reading.timestamp : null;
                const parsed = rawTs ? new Date(rawTs) : null;
                let key;
                let label;

                if (parsed && !Number.isNaN(parsed.getTime())) {
                    const y = parsed.getFullYear();
                    const m = String(parsed.getMonth() + 1).padStart(2, '0');
                    const d = String(parsed.getDate()).padStart(2, '0');
                    const hh = String(parsed.getHours()).padStart(2, '0');
                    const bucketMinute = parsed.getMinutes() < 30 ? '00' : '30';
                    key = `${y}-${m}-${d} ${hh}:${bucketMinute}`;
                    label = `${hh}:${bucketMinute}`;
                } else {
                    key = `unknown-${index}`;
                    label = toTimeLabel(rawTs, index + 1);
                }

                if (!buckets.has(key)) {
                    buckets.set(key, {
                        label,
                        temp1Total: 0,
                        temp1Count: 0,
                        temp2Total: 0,
                        temp2Count: 0,
                        humidity1Total: 0,
                        humidity1Count: 0,
                        humidity2Total: 0,
                        humidity2Count: 0
                    });
                }

                const bucket = buckets.get(key);
                const t1 = Number(reading.temp1);
                const t2 = Number(reading.temp2);
                const h1 = Number(reading.humidity1);
                const h2 = Number(reading.humidity2);
                if (!Number.isNaN(t1)) { bucket.temp1Total += t1; bucket.temp1Count += 1; }
                if (!Number.isNaN(t2)) { bucket.temp2Total += t2; bucket.temp2Count += 1; }
                if (!Number.isNaN(h1)) { bucket.humidity1Total += h1; bucket.humidity1Count += 1; }
                if (!Number.isNaN(h2)) { bucket.humidity2Total += h2; bucket.humidity2Count += 1; }
            });

            return Array.from(buckets.entries())
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([, bucket]) => {
                    const t1 = bucket.temp1Count ? roundOne(bucket.temp1Total / bucket.temp1Count) : null;
                    const t2 = bucket.temp2Count ? roundOne(bucket.temp2Total / bucket.temp2Count) : null;
                    const h1 = bucket.humidity1Count ? roundOne(bucket.humidity1Total / bucket.humidity1Count) : null;
                    const h2 = bucket.humidity2Count ? roundOne(bucket.humidity2Total / bucket.humidity2Count) : null;
                    const t1Txt = t1 === null ? '--' : `${t1.toFixed(1)} C`;
                    const t2Txt = t2 === null ? '--' : `${t2.toFixed(1)} C`;
                    const h1Txt = h1 === null ? '--' : `${h1.toFixed(1)} %`;
                    const h2Txt = h2 === null ? '--' : `${h2.toFixed(1)} %`;
                    return `${bucket.label} | T1 ${t1Txt}, H1 ${h1Txt} | T2 ${t2Txt}, H2 ${h2Txt}`;
                });
        }

        function applySensorStats(stats) {
            const temp1 = Number(stats && stats.avg_temp1);
            const temp2 = Number(stats && stats.avg_temp2);
            const humidity1 = Number(stats && stats.avg_humidity1);
            const humidity2 = Number(stats && stats.avg_humidity2);
            document.getElementById('avgTemp1').textContent = Number.isNaN(temp1) ? '--°C' : temp1.toFixed(1) + '°C';
            document.getElementById('avgTemp2').textContent = Number.isNaN(temp2) ? '--°C' : temp2.toFixed(1) + '°C';
            document.getElementById('avgHumidity1').textContent = Number.isNaN(humidity1) ? '--%' : humidity1.toFixed(1) + '%';
            document.getElementById('avgHumidity2').textContent = Number.isNaN(humidity2) ? '--%' : humidity2.toFixed(1) + '%';
        }

        function drawSensorChart(canvasId, timestamps, temp1Data, temp2Data, humidity1Data, humidity2Data, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (sensorChartInstance) sensorChartInstance.destroy();

            sensorChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        { label: 'Temperature Sensor 1 (°C)', data: temp1Data, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 3 },
                        { label: 'Temperature Sensor 2 (°C)', data: temp2Data, borderColor: '#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 3 },
                        { label: 'Humidity Sensor 1 (%)', data: humidity1Data, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 3 },
                        { label: 'Humidity Sensor 2 (%)', data: humidity2Data, borderColor: '#1abc9c', backgroundColor: 'rgba(26, 188, 156, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'Sensor Readings - ' + label } },
                    scales: { y: { beginAtZero: true }, x: { title: { display: true, text: 'Time (HH:MM)' } } }
                }
            });
        }

        function drawIRChart(canvasId, timestamps, ir1Data, ir2Data, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (irChartInstance) irChartInstance.destroy();

            irChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        { label: 'IR Sensor 1', data: ir1Data, borderColor: '#8e44ad', backgroundColor: 'rgba(142, 68, 173, 0.1)', borderWidth: 2, fill: true, tension: 0.1, pointRadius: 2 },
                        { label: 'IR Sensor 2', data: ir2Data, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.1)', borderWidth: 2, fill: true, tension: 0.1, pointRadius: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'IR Sensor Readings - ' + label } },
                    scales: {
                        y: {
                            min: 0,
                            max: 1,
                            ticks: { stepSize: 1, callback: v => (v === 1 ? 'Detected' : 'Clear') },
                            title: { display: true, text: 'Detection' }
                        },
                        x: { title: { display: true, text: 'Time (HH:MM)' } }
                    }
                }
            });
        }

        async function loadSensorGraphByDate(dateStr) {
            if (!dateStr) return;
            try {
                const res = await fetch('/api/sensor-readings?date=' + encodeURIComponent(dateStr));
                const data = await res.json();
                const readings = data.readings || [];
                document.getElementById('sensorDateLabel').textContent = 'Date: ' + dateStr;

                if (readings.length === 0) {
                    applySensorStats({});
                    drawSensorChart('sensorChart', [], [], [], [], [], dateStr + ' (No Data)');
                    drawIRChart('irSensorChart', [], [], [], dateStr + ' (No Data)');
                    return;
                }

                const timestamps = readings.map((r, idx) => toTimeLabel(r.timestamp, idx + 1));
                const temp1Data = readings.map(r => r.temp1 || null);
                const temp2Data = readings.map(r => r.temp2 || null);
                const humidity1Data = readings.map(r => r.humidity1 || null);
                const humidity2Data = readings.map(r => r.humidity2 || null);
                const ir1Data = readings.map(r => parseIRValue(r.ir1));
                const ir2Data = readings.map(r => parseIRValue(r.ir2));

                applySensorStats(data.stats || {});
                drawSensorChart('sensorChart', timestamps, temp1Data, temp2Data, humidity1Data, humidity2Data, dateStr);
                drawIRChart('irSensorChart', timestamps, ir1Data, ir2Data, dateStr);
            } catch (error) {
                console.error('Error loading sensor graph:', error);
            }
        }

        async function loadSensorGraphFromPicker() {
            const picker = document.getElementById('sensorDatePicker');
            const selected = picker && picker.value ? picker.value : getTodayIsoDate();
            await loadSensorGraphByDate(selected);
        }

        async function loadTodaySensorGraph() {
            const today = getTodayIsoDate();
            const picker = document.getElementById('sensorDatePicker');
            if (picker) picker.value = today;
            await loadSensorGraphByDate(today);
        }

        async function loadSensorTextLogsByDate(dateStr) {
            if (!dateStr) return;
            try {
                const res = await fetch('/api/sensor-readings?date=' + encodeURIComponent(dateStr));
                const data = await res.json();
                const lines = buildThirtyMinuteTextLogs(data.readings || []);
                document.getElementById('sensorTextDateLabel').textContent = 'Date: ' + dateStr;
                renderLogs('sensorTextLogsContainer', lines, `No temperature/humidity logs on ${dateStr}`);
            } catch (error) {
                console.error('Error loading sensor text logs:', error);
                const c = document.getElementById('sensorTextLogsContainer');
                if (c) c.innerHTML = '<div class="log-line">Error loading temperature/humidity logs</div>';
            }
        }

        async function loadSensorTextLogsFromPicker() {
            const picker = document.getElementById('sensorTextDatePicker');
            const selected = picker && picker.value ? picker.value : getTodayIsoDate();
            await loadSensorTextLogsByDate(selected);
        }

        async function loadTodaySensorTextLogs() {
            const today = getTodayIsoDate();
            const picker = document.getElementById('sensorTextDatePicker');
            if (picker) picker.value = today;
            await loadSensorTextLogsByDate(today);
        }

        async function loadStockAlerts() {
            try {
                const res = await fetch('/api/stock-alerts');
                const data = await res.json();
                const alerts = data.alerts || [];
                document.getElementById('criticalCount').textContent = data.total_critical || 0;
                document.getElementById('warningCount').textContent = data.total_warning || 0;
                document.getElementById('alertsLastUpdated').textContent = new Date().toLocaleTimeString();

                const container = document.getElementById('alertsContainer');
                if (alerts.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #27ae60; font-weight: bold;">All items in stock!</div>';
                    return;
                }

                const alertsByMachine = {};
                alerts.forEach(alert => {
                    if (!alertsByMachine[alert.machine_id]) {
                        alertsByMachine[alert.machine_id] = { machine_name: alert.machine_name, critical: [], warning: [] };
                    }
                    if (alert.alert_type === 'out_of_stock') alertsByMachine[alert.machine_id].critical.push(alert);
                    else alertsByMachine[alert.machine_id].warning.push(alert);
                });

                let html = '';
                Object.values(alertsByMachine).forEach(items => {
                    html += `<div style="margin-bottom: 15px;"><div style="font-weight: bold; color: #333; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #ddd;">${escapeHtml(items.machine_name)}</div>`;
                    items.critical.forEach(alert => {
                        html += `<div class="alert-item critical" style="margin-bottom: 8px;"><div class="alert-info"><div class="alert-title">OUT OF STOCK</div><div class="alert-message"><strong>${escapeHtml(alert.item_name)}</strong> (${escapeHtml(alert.category || 'Uncategorized')})<br/>Slots: ${escapeHtml(alert.slots || 'N/A')} | Price: \u20B1${Number(alert.price || 0).toFixed(2)}</div></div></div>`;
                    });
                    items.warning.forEach(alert => {
                        html += `<div class="alert-item warning" style="margin-bottom: 8px;"><div class="alert-info"><div class="alert-title">LOW STOCK</div><div class="alert-message"><strong>${escapeHtml(alert.item_name)}</strong>: ${alert.current_quantity}/${alert.threshold} units<br/>Category: ${escapeHtml(alert.category || 'Uncategorized')} | Slots: ${escapeHtml(alert.slots || 'N/A')}</div></div></div>`;
                    });
                    html += '</div>';
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading stock alerts:', error);
                document.getElementById('alertsContainer').innerHTML = '<div style="padding: 10px; color: #e74c3c;">Error loading alerts</div>';
            }
        }

        async function updateStatus() {
            try {
                const statusRes = await fetch('/api/status/realtime');
                const statusData = await statusRes.json();

                const logsRes = await fetch('/api/sales/today');
                const logsData = await logsRes.json();

                document.getElementById('todaySales').textContent = '\u20B1' + Number(logsData.total_sales || 0).toFixed(2);
                document.getElementById('transactions').textContent = logsData.total_transactions || 0;
                document.getElementById('itemsSold').textContent = Object.values(logsData.items_sold || {}).reduce((a, b) => a + b, 0);

                const grid = document.getElementById('machinesGrid');
                grid.innerHTML = '';
                (statusData || []).forEach(machine => {
                    const lowStockItems = machine.low_stock_items || [];
                    const itemsList = Object.entries(machine.items_sold_today || {}).map(([name, qty]) => `${name}: ${qty}`).join(', ') || 'None';
                    const card = document.createElement('div');
                    card.className = 'machine-card';
                    card.innerHTML = `
                        <div class="machine-header">
                            <h2>${escapeHtml(machine.name)}</h2>
                            <span class="status-badge">${machine.is_active ? 'Active' : 'Offline'}</span>
                        </div>
                        ${lowStockItems.length > 0 ? `<div class="low-stock-alert"><div style="font-weight: bold; color: #c0392b;">Low Stock Alert:</div><div class="alert-items">${lowStockItems.map(escapeHtml).join(', ')}</div></div>` : ''}
                        <div class="machine-stats">
                            <div class="stat-box"><div class="stat-label-small">Total Items</div><div class="stat-value-small">${machine.total_items}</div></div>
                            <div class="stat-box"><div class="stat-label-small">Today's Sales</div><div class="stat-value-small">\u20B1${Number(machine.today_sales || 0).toFixed(2)}</div></div>
                        </div>
                        <div class="items-sold"><div class="items-sold-title">Today's Items Sold:</div><div class="items-sold-list">${escapeHtml(itemsList)}</div></div>
                    `;
                    grid.appendChild(card);
                });

                const picker = document.getElementById('logsDatePicker');
                const selectedDate = picker && picker.value ? picker.value : getTodayIsoDate();
                await loadSalesLogsByDate(selectedDate, 'logsContainer', 'selectedDateLabel');

                await loadStockAlerts();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        const today = getTodayIsoDate();
        const logsPicker = document.getElementById('logsDatePicker');
        if (logsPicker && !logsPicker.value) logsPicker.value = today;

        const sensorPicker = document.getElementById('sensorDatePicker');
        if (sensorPicker && !sensorPicker.value) sensorPicker.value = today;

        const sensorTextPicker = document.getElementById('sensorTextDatePicker');
        if (sensorTextPicker && !sensorTextPicker.value) sensorTextPicker.value = today;

        updateStatus();
        loadTodaySensorGraph();
        loadTodaySensorTextLogs();
        loadStockAlerts();

        setInterval(updateStatus, 5000);
        setInterval(loadTodaySensorGraph, 3600000);
        setInterval(loadTodaySensorTextLogs, 3600000);
        setInterval(loadStockAlerts, 10000);
    </script>
</body>
</html>











